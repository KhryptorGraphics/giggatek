<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abandoned Carts Analytics - Admin Dashboard</title>
    <link rel="stylesheet" href="../css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-container">
        <nav class="admin-sidebar">
            <div class="logo">
                <img src="../img/logo.png" alt="GigGatek Logo">
            </div>
            <ul class="nav-links">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="products.html">Products</a></li>
                <li><a href="orders.html">Orders</a></li>
                <li><a href="customers.html">Customers</a></li>
                <li class="active"><a href="abandoned-carts.html">Abandoned Carts</a></li>
                <li><a href="customer-segments.html">Customer Segments</a></li>
                <li><a href="segment-campaigns.html">Campaigns</a></li>
                <li><a href="ab-testing.html">A/B Testing</a></li>
                <li><a href="marketing-integrations.html">Marketing Integrations</a></li>
                <li><a href="predictive-analytics.html">Predictive Analytics</a></li>
                <li><a href="settings.html">Settings</a></li>
            </ul>
        </nav>

        <main class="admin-content">
            <header class="admin-header">
                <h1>Abandoned Carts Analytics</h1>
                <div class="admin-actions">
                    <a href="abandoned-carts.html" class="btn btn-secondary">Back to Carts</a>
                </div>
            </header>

            <div class="admin-filters">
                <div class="filter-group">
                    <label for="date-range">Date Range:</label>
                    <select id="date-range">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="all">All time</option>
                    </select>
                </div>
            </div>

            <div class="admin-stats">
                <div class="stat-card">
                    <h3>Total Abandoned Carts</h3>
                    <p class="stat-value" id="total-carts">Loading...</p>
                </div>
                <div class="stat-card">
                    <h3>Recovered Carts</h3>
                    <p class="stat-value" id="recovered-carts">Loading...</p>
                </div>
                <div class="stat-card">
                    <h3>Recovery Rate</h3>
                    <p class="stat-value" id="recovery-rate">Loading...</p>
                </div>
                <div class="stat-card">
                    <h3>Avg. Cart Value</h3>
                    <p class="stat-value" id="avg-cart-value">Loading...</p>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-card">
                    <h3>Abandoned Carts Over Time</h3>
                    <canvas id="carts-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Recovery Rate Over Time</h3>
                    <canvas id="recovery-chart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-card">
                    <h3>Top Abandoned Products</h3>
                    <canvas id="products-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Abandonment by Time of Day</h3>
                    <canvas id="time-chart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const totalCartsEl = document.getElementById('total-carts');
            const recoveredCartsEl = document.getElementById('recovered-carts');
            const recoveryRateEl = document.getElementById('recovery-rate');
            const avgCartValueEl = document.getElementById('avg-cart-value');
            const dateRangeFilter = document.getElementById('date-range');

            // Charts
            const cartsChartCtx = document.getElementById('carts-chart').getContext('2d');
            const recoveryChartCtx = document.getElementById('recovery-chart').getContext('2d');
            const productsChartCtx = document.getElementById('products-chart').getContext('2d');
            const timeChartCtx = document.getElementById('time-chart').getContext('2d');

            // State
            let cartsChart, recoveryChart, productsChart, timeChart;

            // Initialize
            loadStats();

            // Add event listeners
            dateRangeFilter.addEventListener('change', () => {
                loadStats();
            });

            /**
             * Load abandoned cart statistics
             */
            function loadStats() {
                // Show loading state
                totalCartsEl.textContent = 'Loading...';
                recoveredCartsEl.textContent = 'Loading...';
                recoveryRateEl.textContent = 'Loading...';
                avgCartValueEl.textContent = 'Loading...';

                // Get date range
                const days = dateRangeFilter.value;

                // Fetch stats from API
                fetch(`/api/abandoned-carts/admin/stats?days=${days}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load statistics');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.stats) {
                        // Update stats
                        totalCartsEl.textContent = data.stats.total_carts;
                        recoveredCartsEl.textContent = data.stats.recovered_carts;
                        recoveryRateEl.textContent = `${data.stats.recovery_rate}%`;
                        avgCartValueEl.textContent = formatCurrency(data.stats.avg_cart_value);

                        // Update charts
                        updateCartsChart(data.stats.daily_carts);
                        updateRecoveryChart(data.stats.daily_carts, data.stats.daily_recoveries);

                        // Simulate data for other charts (in a real implementation, this would come from the API)
                        updateProductsChart();
                        updateTimeChart();
                    }
                })
                .catch(error => {
                    console.error('Error loading stats:', error);

                    // Show error state
                    totalCartsEl.textContent = 'Error';
                    recoveredCartsEl.textContent = 'Error';
                    recoveryRateEl.textContent = 'Error';
                    avgCartValueEl.textContent = 'Error';
                });
            }

            /**
             * Update carts chart
             *
             * @param {Array} dailyCarts - Daily cart data
             */
            function updateCartsChart(dailyCarts) {
                // Sort data by date
                dailyCarts.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Extract labels and data
                const labels = dailyCarts.map(item => formatDateShort(item.date));
                const data = dailyCarts.map(item => item.count);

                // Create or update chart
                if (cartsChart) {
                    cartsChart.data.labels = labels;
                    cartsChart.data.datasets[0].data = data;
                    cartsChart.update();
                } else {
                    cartsChart = new Chart(cartsChartCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Abandoned Carts',
                                data: data,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                }
            }

            /**
             * Update recovery chart
             *
             * @param {Array} dailyCarts - Daily cart data
             * @param {Array} dailyRecoveries - Daily recovery data
             */
            function updateRecoveryChart(dailyCarts, dailyRecoveries) {
                // Create a map of dates to counts
                const cartsByDate = {};
                dailyCarts.forEach(item => {
                    cartsByDate[item.date] = item.count;
                });

                const recoveriesByDate = {};
                dailyRecoveries.forEach(item => {
                    recoveriesByDate[item.date] = item.count;
                });

                // Get all unique dates
                const allDates = [...new Set([...Object.keys(cartsByDate), ...Object.keys(recoveriesByDate)])];
                allDates.sort();

                // Calculate recovery rates
                const labels = [];
                const rates = [];

                allDates.forEach(date => {
                    const carts = cartsByDate[date] || 0;
                    const recoveries = recoveriesByDate[date] || 0;
                    const rate = carts > 0 ? (recoveries / carts) * 100 : 0;

                    labels.push(formatDateShort(date));
                    rates.push(rate.toFixed(2));
                });

                // Create or update chart
                if (recoveryChart) {
                    recoveryChart.data.labels = labels;
                    recoveryChart.data.datasets[0].data = rates;
                    recoveryChart.update();
                } else {
                    recoveryChart = new Chart(recoveryChartCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Recovery Rate (%)',
                                data: rates,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            /**
             * Update products chart (simulated data)
             */
            function updateProductsChart() {
                // Simulated data
                const labels = ['RTX 4090', 'RTX 4080', 'RTX 3090', 'RTX 3080', 'RTX 3070'];
                const data = [42, 35, 28, 22, 18];

                // Create or update chart
                if (productsChart) {
                    productsChart.data.labels = labels;
                    productsChart.data.datasets[0].data = data;
                    productsChart.update();
                } else {
                    productsChart = new Chart(productsChartCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Abandoned Count',
                                data: data,
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.7)',
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(255, 206, 86, 0.7)',
                                    'rgba(75, 192, 192, 0.7)',
                                    'rgba(153, 102, 255, 0.7)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                }
            }

            /**
             * Update time chart (simulated data)
             */
            function updateTimeChart() {
                // Simulated data
                const labels = ['12am-4am', '4am-8am', '8am-12pm', '12pm-4pm', '4pm-8pm', '8pm-12am'];
                const data = [5, 10, 25, 30, 20, 10];

                // Create or update chart
                if (timeChart) {
                    timeChart.data.labels = labels;
                    timeChart.data.datasets[0].data = data;
                    timeChart.update();
                } else {
                    timeChart = new Chart(timeChartCtx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Abandoned Carts',
                                data: data,
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.7)',
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(255, 206, 86, 0.7)',
                                    'rgba(75, 192, 192, 0.7)',
                                    'rgba(153, 102, 255, 0.7)',
                                    'rgba(255, 159, 64, 0.7)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            }

            /**
             * Format currency
             *
             * @param {number} amount - Amount to format
             * @returns {string} Formatted currency
             */
            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amount);
            }

            /**
             * Format date (short)
             *
             * @param {string} dateString - ISO date string
             * @returns {string} Formatted date
             */
            function formatDateShort(dateString) {
                if (!dateString) return 'N/A';

                const date = new Date(dateString);
                return new Intl.DateTimeFormat('en-US', {
                    month: 'short',
                    day: 'numeric'
                }).format(date);
            }

            /**
             * Get auth token
             *
             * @returns {string} Auth token
             */
            function getAuthToken() {
                return localStorage.getItem('auth_token') || '';
            }
        });
    </script>

    <style>
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            height: 300px;
        }

        .chart-card h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: #495057;
        }

        canvas {
            width: 100% !important;
            height: 250px !important;
        }
    </style>
</body>
</html>
